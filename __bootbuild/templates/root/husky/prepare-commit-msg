#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Prepare commit message hook
# Adds branch name to commit message if following conventional naming
# Example: feature/add-auth â†’ [add-auth] in commit message

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Only run for regular commits (not merge, template, squash, etc.)
if [ -n "$COMMIT_SOURCE" ]; then
  exit 0
fi

# Get current branch name
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)

# Skip if not on a branch (detached HEAD)
if [ -z "$BRANCH" ]; then
  exit 0
fi

# Skip for main/master/develop branches
if echo "$BRANCH" | grep -qE "^(main|master|develop|dev)$"; then
  exit 0
fi

# Extract ticket/issue number from branch name
# Supports patterns like: feature/PROJ-123-description, bugfix/456-fix-thing
TICKET=$(echo "$BRANCH" | grep -oE "(feature|bugfix|hotfix)/([A-Z]+-)?[0-9]+" | grep -oE "([A-Z]+-)?[0-9]+")

# If we found a ticket number, prepend it to commit message
if [ -n "$TICKET" ]; then
  COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
  # Only add if not already present
  if ! echo "$COMMIT_MSG" | grep -qE "\[$TICKET\]|\b$TICKET\b"; then
    echo "[$TICKET] $COMMIT_MSG" > "$COMMIT_MSG_FILE"
  fi
fi

exit 0
